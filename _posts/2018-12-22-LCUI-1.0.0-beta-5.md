---
title: LCUI 1.0 Beta 5 开发日志
repo: lc-soft/LCUI
milestone: 8
---
## 2019-02-05
每次调用 Widget_Append() 追加部件时都会更新部件的 last-child 和 first-child 状态，在部件样式类和状态变更后都会调用 Widget_HandleChildrenStyleChange() 检查是否需要更新子级部件，这个检查比较耗时，部件数量多的时候就会很慢。

有以下几个优化方案可以考虑：

- 添加 Widget_AppendList()，用于一次性追加多个部件，避免频繁改动部件的状态。
- 在每帧更新部件时处理部件的 first-child、last-child 状态。
- Widget_HandleChildrenStyleChange() 只在子部件数量大于 1000 时才查样式库检查是否需要更新子部件，否则默认子部件需要更新样式。
- 添加支持自定义部件更新规则，可设置在 active、hover 等状态下是否更新子级别部件样式、仅更新可见区域内的子部件样式。
- 添加支持更新和设置部件 hash 值，当 hash 值不为 0 时，直接从样式表缓存里取对应的样式，hash 值相同的子部件都共用同一样式表，不重新计算。像 active、hover 这些状态作用范围小，一般只会有几个部件处于这些状态，那么在状态变更时可以直接重新计算样式。

## 2019-02-04

用 VS2017 的性能探查器检测 LC-Finder 的内存占用，生成的报告有 3GB，这要是用以前的机器来搞的话读取报告都得等很久。

[![vs2017 内存使用率报告](/static/images/devlog/201902041443.png "vs2017 内存使用率报告")](/static/images/devlog/201902041443.png)

[![vs2017 内存使用率快照#2](/static/images/devlog/201902041453.png "vs2017 内存使用率快照#2")](/static/images/devlog/201902041453.png)

从快照中可以看出样式表占用内存最多，约有 244MB，字符串占用空间 101MB，比部件还多。

以下是可优化的地方：

- 添加字符串池。样式表和部件中的字符串重复率很高，频繁申请内存来存储字符串既浪费空间也降低性能，有了字符串池后，相同内容的字符串只需要申请一次内存。
- 用链表存储样式表。LCUI_StyleSheet 虽然能容纳所有样式属性，读写操作快，但内存利用率低，换成链表存储后，只存储有效的样式属性。

## 2019-01-30

有点纠结该怎么触发 mouseout 和 mouseover 事件，如果给目标部件和它父级所有部件单独触发事件的话，父级部件就无法捕捉到子部件的事件；如果只给目标部件触发事件然后冒泡的话，父部件又不方便判断是不是自己的事件，因为在子部件之间移动鼠标时也会触发 mouseover 和 mouseout 事件，尤其是 mouseout 事件，无法判断是不是因鼠标光标移出父部件而触发的。

mouseout 事件触发条件可以改成单独触发，只要是移出部件，就给这个部件触发 mouseout 事件并默认冒泡，这样就能根据 target 来判断事件是不是自身触发的。

## 2018-12-23

在给 LCFinder 的标签编辑器输入文字时按了方向键，结果被图片查看器捕获到并切换图片，导致正编辑的输入框被销毁。当输入框获得焦点时，应该阻止事件冒泡，如果绑定的全局按键事件，则需要有个函数用于判断是否有激活输入焦点。

## 2018-12-22

绑定和触发事件比较麻烦，例如绑定 change 事件，需要先找与 change 关联的事件 id，没有就会绑定失败。需要调整一下，以字符串作为事件名时，如果没有与之关联的事件 id，则创建一个事件 id 并关联它。
