---
title: LCUI 1.3.1 开发日志
repo: lc-soft/LCUI
toc: true
categories:
  - 开发日志
  - LCUI
---
## 2019-12-29

改进后的重绘效果：

[![paint flashing](/static/images/devlog/improved-widget-style-diff.gif "Paint flashing")](/static/images/devlog/improved-widget-style-diff.gif)

## 2019-12-22

之前提了个重绘区域高亮的改进任务，看到有贡献者提交了 PR 就顺便测试了一下，以 helloworld 程序为例，鼠标悬停在输入框、 `hello, world!` 上会触发重绘，点击个按钮都会触发全屏重绘，这些重绘是多余的，为此，决定改进部件的更新流程。

首先，集中处理部件属性的差异对比和无效区域的标记，原有的部件属性更新函数只负责更新样式，不再考虑属性变化后的副作用。然后，将属性的更新分为两类：

- **布局相关**：包括宽高、定位、位置、内间距、外间距等属性在更新时会触发重新布局和重绘。
- **渲染相关**：包括背景、边框、阴影、可见性、透明度等属性在变化时只触发重绘，如果布局相关属性已更新，或父级部件不可见，或父级布局已标记内容区域需要刷新，则可跳过这些属性的差异对比。

这样处理后，就不需要 `RectList_Add()` 处理重复、重叠的脏矩形了。

## 2019-12-21

在启用 OpenMP 后，可将屏幕划分为 4 个区域来并行渲染，区域高度最小 200 像素。

当前机器的逻辑处理器是 8 个，将并行渲染线程数设置为 8 个后，渲染性能降低，改成 4 个较为合适。

## 2019-12-18

部件数量多的时候，存在以下问题：

- 脏矩形处理耗时长
- 部件样式更新耗时长

以下是性能探查器的检测结果：

[![Performance](/static/images/devlog/test-render-performance-01.png "Performance")](/static/images/devlog/test-render-performance-01.png)

测试程序在每次改完部件样式后会调用 `LCUIWidget_RefreshStyle()` 刷新全部部件样式，一般情况下应用程序并不需要主动调用这个函数，而是应该调用 `Widget_UpdateStyle()` 更新当前改动的部件样式。在调整测试程序后，渲染性能会从 30 帧会降到 5 帧，性能检测结果如下：

[![Performance](/static/images/devlog/test-render-performance-02.png "Performance")](/static/images/devlog/test-render-performance-02.png)

由于 `LCUIWidget_RefreshStyle()` 会标记全屏为无效区域，使后续添加的其它区域都会被忽略掉，所以花费在脏矩形处理上的时间很少。在改成 `Widget_UpdateStyle()` 调用后，总共会添加 3600 个脏矩形，而脏矩形的处理方式很粗暴，每次添加脏矩形时会遍历一遍脏矩形记录，导致性能非常低。
